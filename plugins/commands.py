
import os
import logging
import random
import asyncio
from Script import script
from pyrogram import Client, filters, enums
from pyrogram.errors import ChatAdminRequired, FloodWait
from pyrogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from database.ia_filterdb import Media, get_file_details, unpack_new_file_id, get_bad_files
from database.users_chats_db import db
from info import CHANNELS, ADMINS, AUTH_CHANNEL, LOG_CHANNEL, PICS, BATCH_FILE_CAPTION, CUSTOM_FILE_CAPTION, PROTECT_CONTENT, CHNL_LNK, GRP_LNK, REQST_CHANNEL, SUPPORT_CHAT_ID, MAX_B_TN, IS_VERIFY
from utils import get_settings, get_size, is_subscribed, save_group_settings, temp, verify_user, check_token, check_verification, get_token, send_all
from database.connections_mdb import active_connection
import re
import json
import base64


@Client.on_message(filters.command("startt") & ~filters.private & ~filters.channel)
async def start(client, message):
    if message.chat.type in ['group', 'supergroup']:
        buttons = [
            [
                InlineKeyboardButton('ğŸ“¢ ğš„ğ™¿ğ™³ğ™°ğšƒğ™´ğš‚ ğŸ“¢', url=f'https://t.me/Malayalam_requester_bot')
            ],
            [
                InlineKeyboardButton('â„¹ï¸ ğ™·ğ™´ğ™»ğ™¿ ',callback_data="help")
            ]
            ]
        reply_markup = InlineKeyboardMarkup(buttons)
        disable_web_page_preview = True,
        await message.reply(script.START_TXT.format(message.from_user.mention if message.from_user else message.chat.title, temp.B_LINK), reply_markup=reply_markup)
        if not await db.get_chat(message.chat.id):
            total=await client.get_chat_members_count(message.chat.id)
            await client.send_message(LOG_CHANNEL, script.LOG_TEXT_G.format(message.chat.title, message.chat.id, message.chat.username, total, temp.U_NAME, "Unknown"))       
            await db.add_chat(message.chat.id, message.chat.title, message.chat.username)
        return
 @Client.on_message(filters.command('start'))
async def settings(client, message):
    userid = message.from_user.id if message.from_user else None
    if not userid:
        return await message.reply(f"Yá´á´œ á´€Ê€á´‡ á´€É´á´É´Êá´á´á´œs á´€á´…á´ÉªÉ´. Usá´‡ /connect {message.chat.id} ÉªÉ´ PM")
    chat_type = message.chat.type

    if chat_type == enums.ChatType.PRIVATE:
        grpid = await active_connection(str(userid))
        if grpid is not None:
            grp_id = grpid
            try:
                chat = await client.get_chat(grpid)
                title = chat.title
            except:
                await message.reply_text("Má´€á´‹á´‡ sá´œÊ€á´‡ I'á´ á´˜Ê€á´‡sá´‡É´á´› ÉªÉ´ Êá´á´œÊ€ É¢Ê€á´á´œá´˜ !", quote=True)
                return
        else:
            await message.reply_text("I'á´ É´á´á´› á´„á´É´É´á´‡á´„á´›á´‡á´… á´›á´ á´€É´Ê É¢Ê€á´á´œá´˜s !", quote=True)
            return

    elif chat_type in [enums.ChatType.GROUP, enums.ChatType.SUPERGROUP]:
        grp_id = message.chat.id
        title = message.chat.title

    else:
        return

    st = await client.get_chat_member(grp_id, userid)
    if (
            st.status != enums.ChatMemberStatus.ADMINISTRATOR
            and st.status != enums.ChatMemberStatus.OWNER
            and str(userid) not in ADMINS
    ):
        return
    
    settings = await get_settings(grp_id)

    try:
        if settings['max_btn']:
            settings = await get_settings(grp_id)
    except KeyError:
        await save_group_settings(grp_id, 'max_btn', False)
        settings = await get_settings(grp_id)
    if 'is_shortlink' not in settings.keys():
        await save_group_settings(grp_id, 'is_shortlink', False)
    else:
        pass

    
        btn = [[
                InlineKeyboardButton("Oá´˜á´‡É´ Há´‡Ê€á´‡ â†“", callback_data=f"opnsetgrp#{grp_id}"),
                InlineKeyboardButton("Oá´˜á´‡É´ IÉ´ PM â‡²", callback_data=f"opnsetpm#{grp_id}")
              ]]

        reply_markup = InlineKeyboardMarkup(buttons)
        if chat_type in [enums.ChatType.GROUP, enums.ChatType.SUPERGROUP]:
            await message.reply_text(
                text="<b>Dá´ Êá´á´œ á´¡á´€É´á´› á´›á´ á´á´˜á´‡É´ sá´‡á´›á´›ÉªÉ´É¢s Êœá´‡Ê€á´‡ ?</b>",
                reply_markup=InlineKeyboardMarkup(btn),
                disable_web_page_preview=True,
                parse_mode=enums.ParseMode.HTML,
                reply_to_message_id=message.id
            )
